<!DOCTYPE html>
<html>
<head>
    <title>55Club WinGo Real Predictor Test</title>
</head>
<body>
    <h1>55Club WinGo Real Integration Test</h1>
    <div id="output">Loading real data from 55club.win...</div>
    <script>
        // --- Real 55Club WinGo Integration ---
        // Fetches real periods and results from draw.ar-lottery06.com (55club.win data source)
        (function setupRealPredictor() {
            if (!window._localMock) {
                window._localMock = {};

                const predictionCache = new Map();
                
                window._localMock.pendingPredictions = [];
                window._localMock.statsState = {
                    winRate: 0,
                    totalWins: 0,
                    totalLosses: 0,
                    streak: '',
                    lastFive: ''
                };

                async function fetchRealHistory() {
                    try {
                        const response = await fetch('https://draw.ar-lottery06.com/WinGo/WinGo_30S/GetHistoryIssuePage.json?ts=' + Date.now(), {
                            method: 'GET',
                            headers: { 'User-Agent': 'Mozilla/5.0' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch');
                        const data = await response.json();
                        return data.data?.list || [];
                    } catch (error) {
                        console.warn('[REAL] Failed to fetch history:', error);
                        return [];
                    }
                }

                function getCategory(numberStr) {
                    const num = parseInt(numberStr || '0', 10);
                    return num >= 5 ? 'Big' : 'Small';
                }

                function makeRandomPrediction() {
                    return Math.random() > 0.5 ? 'Big' : 'Small';
                }

                function validatePrediction(predicted, actualNumber) {
                    const actual = getCategory(actualNumber);
                    return predicted === actual ? 'win' : 'loss';
                }

                window._localMock.buildPredictionResult = async function() {
                    try {
                        const history = await fetchRealHistory();
                        if (!history || history.length === 0) throw new Error('No history');

                        const latestIssue = history[0];
                        const period = latestIssue.issueNumber || 'Unknown';
                        
                        // Check if we already made a prediction for this period
                        let prediction = predictionCache.get(period);
                        if (!prediction) {
                            prediction = {
                                category: makeRandomPrediction(),
                                confidence: Math.floor(50 + Math.random() * 40)
                            };
                            predictionCache.set(period, prediction);
                            console.log(`[PREDICTION] New prediction for ${period}: ${prediction.category}`);
                        }

                        // Check if result is resolved (latest issue has a number)
                        let status = 'pending';
                        let actualResult = null;
                        let validationLog = '';
                        
                        if (latestIssue.number) {
                            actualResult = getCategory(latestIssue.number);
                            status = validatePrediction(prediction.category, latestIssue.number);
                            validationLog = `[VALIDATION] Period: ${period} | Predicted: ${prediction.category} | Actual Number: ${latestIssue.number} (${actualResult}) | Result: ${status.toUpperCase()}`;
                            console.log(validationLog);
                            
                            // Update stats if this is a new result
                            if (!predictionCache.has(`${period}_result`)) {
                                if (status === 'win') {
                                    window._localMock.statsState.totalWins++;
                                    console.log(`[STATS] WIN! Total Wins: ${window._localMock.statsState.totalWins}`);
                                } else {
                                    window._localMock.statsState.totalLosses++;
                                    console.log(`[STATS] LOSS! Total Losses: ${window._localMock.statsState.totalLosses}`);
                                }
                                predictionCache.set(`${period}_result`, status);
                            }
                        }

                        // Calculate stats
                        const total = window._localMock.statsState.totalWins + window._localMock.statsState.totalLosses;
                        window._localMock.statsState.winRate = total > 0 ? 
                            Math.round((window._localMock.statsState.totalWins / total) * 100) : 0;

                        // Build streak and patterns from predictions we know about
                        const results = [];
                        for (let i = 0; i < Math.min(5, history.length); i++) {
                            const issue = history[i];
                            const cachedPred = predictionCache.get(issue.issueNumber);
                            
                            if (issue.number && cachedPred) {
                                const validation = validatePrediction(cachedPred.category, issue.number);
                                results.push(validation === 'win' ? 'W' : 'L');
                            }
                        }
                        window._localMock.statsState.streak = results.slice(0, 5).join('');
                        window._localMock.statsState.lastFive = results.slice(0, 5).join(',');

                        // Build entry
                        const entry = {
                            period,
                            prediction: prediction.category,
                            status,
                            confidence: prediction.confidence,
                            category: prediction.category.toLowerCase(),
                            actual: actualResult,
                            actualNumber: latestIssue.number
                        };

                        window._localMock.pendingPredictions.unshift(entry);
                        if (window._localMock.pendingPredictions.length > 8) {
                            window._localMock.pendingPredictions.pop();
                        }

                        return {
                            status: 'OK',
                            predictionResult: {
                                period,
                                prediction: prediction.category,
                                confidence: prediction.confidence,
                                rankedPredictions: Array.from({ length: 3 }, () => ({ 
                                    number: String(Math.floor(Math.random() * 10)) 
                                })),
                                category: prediction.category,
                                status,
                                actualNumber: latestIssue.number,
                                actualCategory: actualResult
                            },
                            pendingPredictions: window._localMock.pendingPredictions.slice()
                        };
                    } catch (error) {
                        console.error('[REAL] Error:', error);
                        return { status: 'ERROR', message: error.message };
                    }
                };

                window._localMock.getStats = function () {
                    const s = Object.assign({}, window._localMock.statsState);
                    return Object.assign({ status: 'OK' }, s);
                };
            }
        })();

        console.log('[TEST] Script started');
        
        async function testAPI() {
            console.log('[TEST] Testing 55club WinGo real integration...');
            try {
                if (window._localMock && window._localMock.buildPredictionResult) {
                    const mockData = await window._localMock.buildPredictionResult();
                    console.log('[TEST] Real Data Response:', mockData);
                    document.getElementById('output').innerHTML = '<pre>' + JSON.stringify(mockData, null, 2) + '</pre>';
                    return;
                }
            } catch (e) {
                console.error('[TEST] Error:', e);
                document.getElementById('output').innerHTML = 'Error: ' + e.message;
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', testAPI);
        } else {
            testAPI();
        }
    </script>
</body>
</html>
